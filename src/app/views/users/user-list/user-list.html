<div class="row">
  <div class="col-xl-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center gap-1">
        <h4 class="card-title flex-grow-1 mb-0">Usuarios</h4>
        <button type="button" class="btn btn-sm btn-primary" (click)="openCreate()">
          Crear usuario
        </button>
      </div>
      <div class="card-body">
        @if (loading) {
          <p class="text-muted mb-0">Cargando usuarios…</p>
        } @else if (error) {
          <div class="alert alert-warning mb-0">
            {{ error }}
          </div>
        } @else if (users.length === 0) {
          <div class="text-center py-5">
            <p class="text-muted mb-3">Aún no hay usuarios.</p>
            <button type="button" class="btn btn-primary" (click)="openCreate()">Crear primer usuario</button>
          </div>
        } @else {
          <div class="table-responsive">
            <table class="table align-middle mb-0 table-hover table-centered">
              <thead class="bg-light-subtle">
                <tr>
                  <th>ID</th>
                  <th>Usuario</th>
                  <th>Email</th>
                  <th>Rol</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody>
                @for (u of users; track u.id) {
                  <tr>
                    <td>{{ u.id }}</td>
                    <td class="fw-medium">{{ u.username }}</td>
                    <td>{{ u.email }}</td>
                    <td><span class="badge bg-{{ u.role === 'ADMIN' ? 'danger' : 'secondary' }}">{{ u.role }}</span></td>
                    <td>{{ u.enabled ? 'Activo' : 'Inactivo' }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </div>
    </div>
  </div>
</div>

@if (createOpen) {
  <div class="modal d-block bg-dark bg-opacity-50" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Crear usuario</h5>
          <button type="button" class="btn-close" aria-label="Close" (click)="closeCreate()"></button>
        </div>
        <form [formGroup]="createForm" (ngSubmit)="submitCreate()">
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label" for="username">Usuario</label>
              <input type="text" class="form-control" id="username" formControlName="username" placeholder="Usuario" />
              @if (createForm.get('username')?.invalid && createForm.get('username')?.touched) {
                <div class="text-danger small">Requerido, mínimo 2 caracteres</div>
              }
            </div>
            <div class="mb-3">
              <label class="form-label" for="email">Email</label>
              <input type="email" class="form-control" id="email" formControlName="email" placeholder="email@ejemplo.com" />
              @if (createForm.get('email')?.invalid && createForm.get('email')?.touched) {
                <div class="text-danger small">Email válido requerido</div>
              }
            </div>
            <div class="mb-3">
              <label class="form-label" for="password">Contraseña</label>
              <input type="password" class="form-control" id="password" formControlName="password" placeholder="Mínimo 4 caracteres" />
              @if (createForm.get('password')?.invalid && createForm.get('password')?.touched) {
                <div class="text-danger small">Mínimo 4 caracteres</div>
              }
            </div>
            <div class="mb-3">
              <label class="form-label" for="role">Rol</label>
              <select class="form-select" id="role" formControlName="role">
                <option value="USER">USER – Solo proyectos</option>
                <option value="ADMIN">ADMIN – Acceso total</option>
              </select>
            </div>
            @if (createError) {
              <div class="alert alert-danger py-2">{{ createError }}</div>
            }
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-soft-secondary" (click)="closeCreate()">Cancelar</button>
            <button type="submit" class="btn btn-primary" [disabled]="createForm.invalid || createLoading">
              {{ createLoading ? 'Creando…' : 'Crear' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade show"></div>
}
