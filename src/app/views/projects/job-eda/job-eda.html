<div class="row">
  <div class="col-xl-12">
    @if (loading) {
    <p class="text-muted">Cargando gráficas EDA…</p>
    } @else if (error) {
    <div class="alert alert-warning">{{ error }}</div>
    } @else {
    <div class="d-flex align-items-center gap-2 mb-4">
      <a
        [routerLink]="['/projects/detail', projectId, 'job', jobId]"
        class="btn btn-sm btn-outline-secondary"
        >← Volver al job</a
      >
      <h4 class="mb-0">EDA – Job {{ jobId }}</h4>
    </div>

    <div class="row justify-content-center mb-3">
      <div class="col-12 col-sm-8 col-md-6 col-lg-4">
        <div class="card">
          <div
            class="card-header d-flex align-items-center justify-content-between gap-2 py-2"
          >
            <h5 class="card-title mb-0">Calidad global</h5>
            <button
              type="button"
              class="btn btn-sm btn-outline-primary"
              (click)="openMetricInfoModal(datasetQualityInfoModal)"
            >
              Información
            </button>
          </div>
          <div class="card-body text-center py-3">
            @if (datasetQuality != null) {
            <p class="mb-0 fs-4 fw-semibold">
              {{ (datasetQuality * 100) | number:'1.0-1' }}%
            </p>
            } @else if (datasetQualityError) {
            <p class="text-muted mb-0 small">
              No se pudo cargar la calidad del dataset.
            </p>
            } @else {
            <p class="text-muted mb-0 small">Cargando…</p>
            }
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div
        class="card-header d-flex align-items-center justify-content-between gap-2 flex-wrap"
      >
        <h5 class="card-title mb-0">Estadísticas descriptivas</h5>
        @if (descriptiveStats) {
        <button
          type="button"
          class="btn btn-sm btn-outline-primary"
          (click)="openQualityInfoModal()"
        >
          Cómo se calcula el índice de calidad
        </button>
        }
      </div>
      <div class="card-body p-0">
        @if (descriptiveStats) {
        <div class="table-responsive">
          <table class="table table-bordered table-sm mb-0">
            <thead class="table-light">
              <tr>
                <th></th>
                @for (col of statsColumns; track col) {
                <th class="text-center">{{ metricLabels[col] || col }}</th>
                }
              </tr>
            </thead>
            <tbody>
              @for (row of statsRows; track row.key) {
              <tr>
                <th class="text-nowrap">{{ row.label }}</th>
                @for (col of statsColumns; track col) {
                <td class="text-end font-monospace">
                  {{ statCellValue(col, row.key) }} @if (row.key === 'cv' &&
                  cvBadgeLabel(col); as badge) {
                  <span
                    class="ms-2 badge"
                    style="color: black"
                    [class.bg-danger]="badge === 'Bajo'"
                    [class.bg-warning]="badge === 'Medio'"
                    [class.bg-success]="badge === 'Alto'"
                    >{{ badge }}</span
                  >
                  }
                </td>
                }
              </tr>
              }
            </tbody>
          </table>
        </div>
        } @else if (descriptiveStatsError) {
        <p class="text-muted mb-0 p-3">
          No se pudieron cargar las estadísticas descriptivas.
        </p>
        } @else {
        <p class="text-muted mb-0 p-3">Cargando estadísticas…</p>
        }
      </div>
    </div>

    <div class="row g-3">
      @for (item of charts; track getChartId(item, $index)) { @if (item.metric
      === 'ptm' && item.type === 'distribution') {
      <div class="col-12 col-lg-6">
        <div class="card mb-0 h-100">
          <div
            class="card-header d-flex align-items-center justify-content-between gap-2 py-3"
          >
            <h5 class="card-title mb-0">pTM</h5>
            <button
              type="button"
              class="btn btn-sm btn-outline-primary"
              (click)="openMetricInfoModal(ptmInfoModal)"
            >
              Información
            </button>
          </div>
          <div class="card-body">
            <div class="card mb-3">
              <div class="card-body">
                <div
                  class="apex-charts"
                  [attr.id]="'chart-' + getChartId(item, $index)"
                >
                  <apx-chart
                    [chart]="item.options.chart!"
                    [series]="item.options.series!"
                    [xaxis]="item.options.xaxis!"
                    [yaxis]="item.options.yaxis!"
                    [plotOptions]="item.options.plotOptions!"
                    [dataLabels]="item.options.dataLabels!"
                    [stroke]="item.options.stroke!"
                    [fill]="item.options.fill!"
                    [colors]="item.options.colors!"
                    [legend]="item.options.legend!"
                    [grid]="item.options.grid!"
                    [tooltip]="item.options.tooltip!"
                    [title]="item.options.title!"
                    [annotations]="item.options.annotations!"
                  />
                </div>
              </div>
            </div>
            @if (getPtmBinsChart(); as ptmBins) {
            <div class="card mb-0">
              <div class="card-body">
                <div class="apex-charts" id="chart-ptm-bins">
                  <apx-chart
                    [chart]="ptmBins.options.chart!"
                    [series]="ptmBins.options.series!"
                    [xaxis]="ptmBins.options.xaxis!"
                    [yaxis]="ptmBins.options.yaxis!"
                    [plotOptions]="ptmBins.options.plotOptions!"
                    [dataLabels]="ptmBins.options.dataLabels!"
                    [stroke]="ptmBins.options.stroke!"
                    [fill]="ptmBins.options.fill!"
                    [colors]="ptmBins.options.colors!"
                    [legend]="ptmBins.options.legend!"
                    [grid]="ptmBins.options.grid!"
                    [tooltip]="ptmBins.options.tooltip!"
                    [title]="ptmBins.options.title!"
                    [annotations]="ptmBins.options.annotations!"
                  />
                </div>
              </div>
            </div>
            }
          </div>
        </div>
      </div>
      } @if (item.metric === 'i_ptm' && item.type === 'distribution') {
      <div class="col-12 col-lg-6">
        <div class="card mb-0 h-100">
          <div
            class="card-header d-flex align-items-center justify-content-between gap-2 py-3"
          >
            <h5 class="card-title mb-0">iPTM</h5>
            <button
              type="button"
              class="btn btn-sm btn-outline-primary"
              (click)="openMetricInfoModal(iptmInfoModal)"
            >
              Información
            </button>
          </div>
          <div class="card-body">
            <div class="card mb-3">
              <div class="card-body">
                <div
                  class="apex-charts"
                  [attr.id]="'chart-' + getChartId(item, $index)"
                >
                  <apx-chart
                    [chart]="item.options.chart!"
                    [series]="item.options.series!"
                    [xaxis]="item.options.xaxis!"
                    [yaxis]="item.options.yaxis!"
                    [plotOptions]="item.options.plotOptions!"
                    [dataLabels]="item.options.dataLabels!"
                    [stroke]="item.options.stroke!"
                    [fill]="item.options.fill!"
                    [colors]="item.options.colors!"
                    [legend]="item.options.legend!"
                    [grid]="item.options.grid!"
                    [tooltip]="item.options.tooltip!"
                    [title]="item.options.title!"
                    [annotations]="item.options.annotations!"
                  />
                </div>
              </div>
            </div>
            @if (getIptmBinsChart(); as iptmBins) {
            <div class="card mb-0">
              <div class="card-body">
                <div class="apex-charts" id="chart-iptm-bins">
                  <apx-chart
                    [chart]="iptmBins.options.chart!"
                    [series]="iptmBins.options.series!"
                    [xaxis]="iptmBins.options.xaxis!"
                    [yaxis]="iptmBins.options.yaxis!"
                    [plotOptions]="iptmBins.options.plotOptions!"
                    [dataLabels]="iptmBins.options.dataLabels!"
                    [stroke]="iptmBins.options.stroke!"
                    [fill]="iptmBins.options.fill!"
                    [colors]="iptmBins.options.colors!"
                    [legend]="iptmBins.options.legend!"
                    [grid]="iptmBins.options.grid!"
                    [tooltip]="iptmBins.options.tooltip!"
                    [title]="iptmBins.options.title!"
                    [annotations]="iptmBins.options.annotations!"
                  />
                </div>
              </div>
            </div>
            }
          </div>
        </div>
      </div>
      } @if (item.metric === 'pae' && item.type === 'distribution') {
      <div class="col-12 col-lg-6">
        <div class="card mb-0 h-100">
          <div
            class="card-header d-flex align-items-center justify-content-between gap-2 py-3"
          >
            <h5 class="card-title mb-0">PAE</h5>
            <button
              type="button"
              class="btn btn-sm btn-outline-primary"
              (click)="openMetricInfoModal(paeInfoModal)"
            >
              Información
            </button>
          </div>
          <div class="card-body">
            <div class="card mb-3">
              <div class="card-body">
                <div
                  class="apex-charts"
                  [attr.id]="'chart-' + getChartId(item, $index)"
                >
                  <apx-chart
                    [chart]="item.options.chart!"
                    [series]="item.options.series!"
                    [xaxis]="item.options.xaxis!"
                    [yaxis]="item.options.yaxis!"
                    [plotOptions]="item.options.plotOptions!"
                    [dataLabels]="item.options.dataLabels!"
                    [stroke]="item.options.stroke!"
                    [fill]="item.options.fill!"
                    [colors]="item.options.colors!"
                    [legend]="item.options.legend!"
                    [grid]="item.options.grid!"
                    [tooltip]="item.options.tooltip!"
                    [title]="item.options.title!"
                    [annotations]="item.options.annotations!"
                  />
                </div>
              </div>
            </div>
            @if (getPaeBinsChart(); as paeBins) {
            <div class="card mb-0">
              <div class="card-body">
                <div class="apex-charts" id="chart-pae-bins">
                  <apx-chart
                    [chart]="paeBins.options.chart!"
                    [series]="paeBins.options.series!"
                    [xaxis]="paeBins.options.xaxis!"
                    [yaxis]="paeBins.options.yaxis!"
                    [plotOptions]="paeBins.options.plotOptions!"
                    [dataLabels]="paeBins.options.dataLabels!"
                    [stroke]="paeBins.options.stroke!"
                    [fill]="paeBins.options.fill!"
                    [colors]="paeBins.options.colors!"
                    [legend]="paeBins.options.legend!"
                    [grid]="paeBins.options.grid!"
                    [tooltip]="paeBins.options.tooltip!"
                    [title]="paeBins.options.title!"
                    [annotations]="paeBins.options.annotations!"
                  />
                </div>
              </div>
            </div>
            }
          </div>
        </div>
      </div>
      } @if (item.metric === 'i_pae' && item.type === 'distribution') {
      <div class="col-12 col-lg-6">
        <div class="card mb-0 h-100">
          <div
            class="card-header d-flex align-items-center justify-content-between gap-2 py-3"
          >
            <h5 class="card-title mb-0">iPAE</h5>
            <button
              type="button"
              class="btn btn-sm btn-outline-primary"
              (click)="openMetricInfoModal(ipaeInfoModal)"
            >
              Información
            </button>
          </div>
          <div class="card-body">
            <div class="card mb-3">
              <div class="card-body">
                <div
                  class="apex-charts"
                  [attr.id]="'chart-' + getChartId(item, $index)"
                >
                  <apx-chart
                    [chart]="item.options.chart!"
                    [series]="item.options.series!"
                    [xaxis]="item.options.xaxis!"
                    [yaxis]="item.options.yaxis!"
                    [plotOptions]="item.options.plotOptions!"
                    [dataLabels]="item.options.dataLabels!"
                    [stroke]="item.options.stroke!"
                    [fill]="item.options.fill!"
                    [colors]="item.options.colors!"
                    [legend]="item.options.legend!"
                    [grid]="item.options.grid!"
                    [tooltip]="item.options.tooltip!"
                    [title]="item.options.title!"
                    [annotations]="item.options.annotations!"
                  />
                </div>
              </div>
            </div>
            @if (getIpaeBinsChart(); as ipaeBins) {
            <div class="card mb-0">
              <div class="card-body">
                <div class="apex-charts" id="chart-ipae-bins">
                  <apx-chart
                    [chart]="ipaeBins.options.chart!"
                    [series]="ipaeBins.options.series!"
                    [xaxis]="ipaeBins.options.xaxis!"
                    [yaxis]="ipaeBins.options.yaxis!"
                    [plotOptions]="ipaeBins.options.plotOptions!"
                    [dataLabels]="ipaeBins.options.dataLabels!"
                    [stroke]="ipaeBins.options.stroke!"
                    [fill]="ipaeBins.options.fill!"
                    [colors]="ipaeBins.options.colors!"
                    [legend]="ipaeBins.options.legend!"
                    [grid]="ipaeBins.options.grid!"
                    [tooltip]="ipaeBins.options.tooltip!"
                    [title]="ipaeBins.options.title!"
                    [annotations]="ipaeBins.options.annotations!"
                  />
                </div>
              </div>
            </div>
            }
          </div>
        </div>
      </div>
      } @if (item.metric === 'plddt' && item.type === 'distribution') {
      <div class="col-12 col-lg-6">
        <div class="card mb-0 h-100">
          <div
            class="card-header d-flex align-items-center justify-content-between gap-2 py-3"
          >
            <h5 class="card-title mb-0">pLDDT</h5>
            <button
              type="button"
              class="btn btn-sm btn-outline-primary"
              (click)="openMetricInfoModal(plddtInfoModal)"
            >
              Información
            </button>
          </div>
          <div class="card-body">
            <div class="card mb-3">
              <div class="card-body">
                <div
                  class="apex-charts"
                  [attr.id]="'chart-' + getChartId(item, $index)"
                >
                  <apx-chart
                    [chart]="item.options.chart!"
                    [series]="item.options.series!"
                    [xaxis]="item.options.xaxis!"
                    [yaxis]="item.options.yaxis!"
                    [plotOptions]="item.options.plotOptions!"
                    [dataLabels]="item.options.dataLabels!"
                    [stroke]="item.options.stroke!"
                    [fill]="item.options.fill!"
                    [colors]="item.options.colors!"
                    [legend]="item.options.legend!"
                    [grid]="item.options.grid!"
                    [tooltip]="item.options.tooltip!"
                    [title]="item.options.title!"
                    [annotations]="item.options.annotations!"
                  />
                </div>
              </div>
            </div>
            @if (getPlddtBinsChart(); as plddtBins) {
            <div class="card mb-0">
              <div class="card-body">
                <div class="apex-charts" id="chart-plddt-bins">
                  <apx-chart
                    [chart]="plddtBins.options.chart!"
                    [series]="plddtBins.options.series!"
                    [xaxis]="plddtBins.options.xaxis!"
                    [yaxis]="plddtBins.options.yaxis!"
                    [plotOptions]="plddtBins.options.plotOptions!"
                    [dataLabels]="plddtBins.options.dataLabels!"
                    [stroke]="plddtBins.options.stroke!"
                    [fill]="plddtBins.options.fill!"
                    [colors]="plddtBins.options.colors!"
                    [legend]="plddtBins.options.legend!"
                    [grid]="plddtBins.options.grid!"
                    [tooltip]="plddtBins.options.tooltip!"
                    [title]="plddtBins.options.title!"
                    [annotations]="plddtBins.options.annotations!"
                  />
                </div>
              </div>
            </div>
            }
          </div>
        </div>
      </div>
      } @if (item.metric === 'rmsd' && item.type === 'distribution') {
      <div class="col-12 col-lg-6">
        <div class="card mb-0 h-100">
          <div
            class="card-header d-flex align-items-center justify-content-between gap-2 py-3"
          >
            <h5 class="card-title mb-0">RMSD</h5>
            <button
              type="button"
              class="btn btn-sm btn-outline-primary"
              (click)="openMetricInfoModal(rmsdInfoModal)"
            >
              Información
            </button>
          </div>
          <div class="card-body">
            <div class="card mb-3">
              <div class="card-body">
                <div
                  class="apex-charts"
                  [attr.id]="'chart-' + getChartId(item, $index)"
                >
                  <apx-chart
                    [chart]="item.options.chart!"
                    [series]="item.options.series!"
                    [xaxis]="item.options.xaxis!"
                    [yaxis]="item.options.yaxis!"
                    [plotOptions]="item.options.plotOptions!"
                    [dataLabels]="item.options.dataLabels!"
                    [stroke]="item.options.stroke!"
                    [fill]="item.options.fill!"
                    [colors]="item.options.colors!"
                    [legend]="item.options.legend!"
                    [grid]="item.options.grid!"
                    [tooltip]="item.options.tooltip!"
                    [title]="item.options.title!"
                    [annotations]="item.options.annotations!"
                  />
                </div>
              </div>
            </div>
            @if (getRmsdBinsChart(); as rmsdBins) {
            <div class="card mb-0">
              <div class="card-body">
                <div class="apex-charts" id="chart-rmsd-bins">
                  <apx-chart
                    [chart]="rmsdBins.options.chart!"
                    [series]="rmsdBins.options.series!"
                    [xaxis]="rmsdBins.options.xaxis!"
                    [yaxis]="rmsdBins.options.yaxis!"
                    [plotOptions]="rmsdBins.options.plotOptions!"
                    [dataLabels]="rmsdBins.options.dataLabels!"
                    [stroke]="rmsdBins.options.stroke!"
                    [fill]="rmsdBins.options.fill!"
                    [colors]="rmsdBins.options.colors!"
                    [legend]="rmsdBins.options.legend!"
                    [grid]="rmsdBins.options.grid!"
                    [tooltip]="rmsdBins.options.tooltip!"
                    [title]="rmsdBins.options.title!"
                    [annotations]="rmsdBins.options.annotations!"
                  />
                </div>
              </div>
            </div>
            }
          </div>
        </div>
      </div>
      } @if (item.metric === 'mpnn' && item.type === 'distribution') {
      <div class="col-12 col-lg-6">
        <div class="card mb-0 h-100">
          <div
            class="card-header d-flex align-items-center justify-content-between gap-2 py-3"
          >
            <h5 class="card-title mb-0">MPNN</h5>
            <button
              type="button"
              class="btn btn-sm btn-outline-primary"
              (click)="openMetricInfoModal(mpnnInfoModal)"
            >
              Información
            </button>
          </div>
          <div class="card-body">
            <div class="card mb-0">
              <div class="card-body">
                <div
                  class="apex-charts"
                  [attr.id]="'chart-' + getChartId(item, $index)"
                >
                  <apx-chart
                    [chart]="item.options.chart!"
                    [series]="item.options.series!"
                    [xaxis]="item.options.xaxis!"
                    [yaxis]="item.options.yaxis!"
                    [plotOptions]="item.options.plotOptions!"
                    [dataLabels]="item.options.dataLabels!"
                    [stroke]="item.options.stroke!"
                    [fill]="item.options.fill!"
                    [colors]="item.options.colors!"
                    [legend]="item.options.legend!"
                    [grid]="item.options.grid!"
                    [tooltip]="item.options.tooltip!"
                    [title]="item.options.title!"
                    [annotations]="item.options.annotations!"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      } @if (item.metric !== 'ptm' && item.metric !== 'i_ptm' && item.metric !==
      'pae' && item.metric !== 'i_pae' && item.metric !== 'plddt' && item.metric
      !== 'rmsd' && item.metric !== 'mpnn') {
      <div class="col-12 col-lg-6">
        <div class="card mb-0 h-100">
          <div class="card-body">
            <div
              class="apex-charts"
              [attr.id]="'chart-' + getChartId(item, $index)"
            >
              <apx-chart
                [chart]="item.options.chart!"
                [series]="item.options.series!"
                [xaxis]="item.options.xaxis!"
                [yaxis]="item.options.yaxis!"
                [plotOptions]="item.options.plotOptions!"
                [dataLabels]="item.options.dataLabels!"
                [stroke]="item.options.stroke!"
                [fill]="item.options.fill!"
                [colors]="item.options.colors!"
                [legend]="item.options.legend!"
                [grid]="item.options.grid!"
                [tooltip]="item.options.tooltip!"
                [title]="item.options.title!"
                [annotations]="item.options.annotations!"
              />
            </div>
          </div>
        </div>
      </div>
      } }
    </div>
    }

    <ng-template #ptmInfoModal let-modal>
      <div class="modal-header">
        <h5 class="modal-title">pTM – Información</h5>
        <button
          type="button"
          class="btn-close"
          aria-label="Cerrar"
          (click)="modal.dismiss()"
        ></button>
      </div>
      <div class="modal-body mpnn-info-body">
        <h4 class="fw-semibold mb-2">¿Qué mide?</h4>
        <p class="text-muted mb-3">Predicted TM-score global.</p>
        <h4 class="fw-semibold mb-2">Rango posible</h4>
        <p class="text-muted mb-3">0 – 1</p>
        <h4 class="fw-semibold mb-2">Interpretación</h4>
        <ul class="text-muted mb-0 ps-3">
          <li>&gt;0.8 → Alta confianza estructural global</li>
          <li>0.6–0.8 → Estructura plausible</li>
          <li>&lt;0.6 → Baja confianza</li>
          <li>
            Si la distribución es estrecha y alta → modelos similares y
            confiables.
          </li>
          <li>Si es amplia → dataset estructuralmente diverso.</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.close()">
          Cerrar
        </button>
      </div>
    </ng-template>

    <ng-template #iptmInfoModal let-modal>
      <div class="modal-header">
        <h5 class="modal-title">iPTM – Información</h5>
        <button
          type="button"
          class="btn-close"
          aria-label="Cerrar"
          (click)="modal.dismiss()"
        ></button>
      </div>
      <div class="modal-body mpnn-info-body">
        <h4 class="fw-semibold mb-2">¿Qué mide?</h4>
        <p class="text-muted mb-3">
          Interface predicted TM-score. Evalúa la calidad de la interfaz
          proteína–proteína.
        </p>
        <h4 class="fw-semibold mb-2">Rango posible</h4>
        <p class="text-muted mb-3">0 – 1</p>
        <h4 class="fw-semibold mb-2">Interpretación</h4>
        <ul class="text-muted mb-0 ps-3">
          <li>&gt;0.8 → Interacción muy confiable</li>
          <li>0.6–0.8 → Interacción plausible</li>
          <li>&lt;0.6 → Interfaz incierta</li>
          <li>Distribución amplia → variedad en calidad de interacciones.</li>
          <li>Distribución concentrada → comportamiento homogéneo.</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.close()">
          Cerrar
        </button>
      </div>
    </ng-template>

    <ng-template #paeInfoModal let-modal>
      <div class="modal-header">
        <h5 class="modal-title">PAE – Información</h5>
        <button
          type="button"
          class="btn-close"
          aria-label="Cerrar"
          (click)="modal.dismiss()"
        ></button>
      </div>
      <div class="modal-body mpnn-info-body">
        <h4 class="fw-semibold mb-2">¿Qué mide?</h4>
        <p class="text-muted mb-3">
          Predicted Aligned Error. Error esperado entre posiciones alineadas.
        </p>
        <h4 class="fw-semibold mb-2">Rango típico</h4>
        <p class="text-muted mb-3">0 – ~30 Å (puede variar).</p>
        <h4 class="fw-semibold mb-2">Interpretación</h4>
        <ul class="text-muted mb-0 ps-3">
          <li>Valores bajos → alta precisión estructural</li>
          <li>Valores altos → incertidumbre en la orientación relativa</li>
          <li>
            Distribución sesgada a la derecha → algunos modelos con errores
            grandes.
          </li>
          <li>Distribución concentrada en valores bajos → modelos precisos.</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.close()">
          Cerrar
        </button>
      </div>
    </ng-template>

    <ng-template #ipaeInfoModal let-modal>
      <div class="modal-header">
        <h5 class="modal-title">iPAE – Información</h5>
        <button
          type="button"
          class="btn-close"
          aria-label="Cerrar"
          (click)="modal.dismiss()"
        ></button>
      </div>
      <div class="modal-body mpnn-info-body">
        <h4 class="fw-semibold mb-2">¿Qué mide?</h4>
        <p class="text-muted mb-3">PAE restringido a la interfaz.</p>
        <h4 class="fw-semibold mb-2">Rango típico</h4>
        <p class="text-muted mb-3">0 – ~30 Å</p>
        <h4 class="fw-semibold mb-2">Interpretación</h4>
        <ul class="text-muted mb-0 ps-3">
          <li>Valores bajos → interfaz bien definida</li>
          <li>Alta varianza → interfaces heterogéneas</li>
          <li>Es complementaria a i_ptm.</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.close()">
          Cerrar
        </button>
      </div>
    </ng-template>

    <ng-template #plddtInfoModal let-modal>
      <div class="modal-header">
        <h5 class="modal-title">pLDDT – Información</h5>
        <button
          type="button"
          class="btn-close"
          aria-label="Cerrar"
          (click)="modal.dismiss()"
        ></button>
      </div>
      <div class="modal-body mpnn-info-body">
        <h4 class="fw-semibold mb-2">¿Qué mide?</h4>
        <p class="text-muted mb-3">
          Predicted Local Distance Difference Test. Confianza local por residuo
          en AlphaFold.
        </p>
        <h4 class="fw-semibold mb-2">Rango posible</h4>
        <p class="text-muted mb-3">0 – 100</p>
        <h4 class="fw-semibold mb-2">Interpretación</h4>
        <ul class="text-muted mb-0 ps-3">
          <li>&gt;90 → Muy alta confianza</li>
          <li>70–90 → Buena confianza</li>
          <li>&lt;70 → Baja confianza</li>
          <li>
            Distribución concentrada en valores altos → modelos estructuralmente
            confiables.
          </li>
          <li>
            Distribución amplia → mezcla de regiones confiables e inciertas.
          </li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.close()">
          Cerrar
        </button>
      </div>
    </ng-template>

    <ng-template #rmsdInfoModal let-modal>
      <div class="modal-header">
        <h5 class="modal-title">RMSD – Información</h5>
        <button
          type="button"
          class="btn-close"
          aria-label="Cerrar"
          (click)="modal.dismiss()"
        ></button>
      </div>
      <div class="modal-body mpnn-info-body">
        <h4 class="fw-semibold mb-2">¿Qué mide?</h4>
        <p class="text-muted mb-3">
          Root Mean Square Deviation. Diferencia estructural respecto a una
          referencia.
        </p>
        <h4 class="fw-semibold mb-2">Rango posible</h4>
        <p class="text-muted mb-3">≥ 0 Å</p>
        <h4 class="fw-semibold mb-2">Interpretación</h4>
        <ul class="text-muted mb-0 ps-3">
          <li>&lt;2 Å → Excelente ajuste</li>
          <li>2–5 Å → Moderado</li>
          <li>&gt;5 Å → Baja similitud estructural</li>
          <li>Distribución amplia → alta diversidad estructural.</li>
          <li>Distribución estrecha → modelos similares.</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.close()">
          Cerrar
        </button>
      </div>
    </ng-template>

    <ng-template #mpnnInfoModal let-modal>
      <div class="modal-header">
        <h5 class="modal-title">MPNN – Información</h5>
        <button
          type="button"
          class="btn-close"
          aria-label="Cerrar"
          (click)="modal.dismiss()"
        ></button>
      </div>
      <div class="modal-body mpnn-info-body">
        <h4 class="fw-semibold mb-2">¿Qué mide?</h4>
        <p class="text-muted mb-3">
          Score generado por ProteinMPNN. Generalmente representa una energía o
          log-probabilidad del diseño de secuencia.
        </p>
        <h4 class="fw-semibold mb-2">Rango posible</h4>
        <p class="text-muted mb-3">
          No tiene un rango fijo universal. Puede tomar valores negativos.
        </p>
        <h4 class="fw-semibold mb-2">Interpretación</h4>
        <ul class="text-muted mb-0 ps-3">
          <li>Valores más bajos suelen indicar secuencias más favorables.</li>
          <li>Alta desviación estándar → mayor diversidad en diseños.</li>
          <li>Distribución estrecha → diseños homogéneos.</li>
          <li>
            Distribución amplia → alta variabilidad estructural o energética.
          </li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.close()">
          Cerrar
        </button>
      </div>
    </ng-template>

    <ng-template #datasetQualityInfoModal let-modal>
      <div class="modal-header">
        <h5 class="modal-title">Calidad global del dataset</h5>
        <button
          type="button"
          class="btn-close"
          aria-label="Cerrar"
          (click)="modal.dismiss()"
        ></button>
      </div>
      <div class="modal-body mpnn-info-body dataset-quality">
        <section class="dataset-quality">
          <h2>Cómo se calcula la calidad global del dataset (0%–100%)</h2>

          <p>
            La calidad global resume en un solo número qué tan "saludable" está
            el dataset en conjunto, combinando la calidad individual de cada
            métrica (por ejemplo: <code>ptm</code>, <code>plddt</code>,
            <code>pae</code>, etc.). El resultado final también está en escala
            <strong>0 a 100</strong>.
          </p>

          <h3>1) Paso previo: calidad por métrica</h3>
          <p>
            Para cada métrica se calcula primero un
            <strong>quality</strong> (0–100) con el algoritmo de calidad
            individual. A partir de esos valores individuales se construye la
            calidad global.
          </p>

          <h3>2) Combinación mediante promedio ponderado</h3>
          <p>
            La calidad global se calcula como un
            <strong>promedio ponderado</strong>, donde algunas métricas pesan
            más que otras, dependiendo de qué tan relevantes son para evaluar la
            calidad del dataset.
          </p>

          <div class="formula">
            <code>
              Q<sub>dataset</sub> = ( Σ (w<sub>j</sub> · Q<sub>j</sub>) ) / ( Σ
              w<sub>j</sub> )
            </code>
          </div>

          <p>Donde:</p>
          <ul>
            <li>
              <code>Q<sub>j</sub></code> es la calidad (0–100) de la métrica
              <code>j</code>.
            </li>
            <li>
              <code>w<sub>j</sub></code> es el peso asignado a esa métrica.
            </li>
            <li>
              Si una métrica no tiene datos válidos (quality nulo), simplemente
              no se considera.
            </li>
          </ul>

          <h3>3) Pesos usados</h3>
          <p>
            En la implementación actual se utilizan estos pesos (la suma total
            es 1.0):
          </p>

          <table class="weights-table table table-bordered table-sm">
            <thead>
              <tr>
                <th>Métrica</th>
                <th>Peso</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>ptm</code></td>
                <td>0.15</td>
              </tr>
              <tr>
                <td><code>plddt</code></td>
                <td>0.15</td>
              </tr>
              <tr>
                <td><code>pae</code></td>
                <td>0.15</td>
              </tr>
              <tr>
                <td><code>rmsd</code></td>
                <td>0.15</td>
              </tr>
              <tr>
                <td><code>i_ptm</code></td>
                <td>0.20</td>
              </tr>
              <tr>
                <td><code>i_pae</code></td>
                <td>0.20</td>
              </tr>
              <tr>
                <td><code>mpnn</code></td>
                <td>0.00</td>
              </tr>
            </tbody>
          </table>

          <p>
            Nota: <code>mpnn</code> está en 0.00 porque su interpretación puede
            variar entre pipelines; si para tu caso es relevante, se le puede
            asignar un peso distinto.
          </p>

          <h3>4) Comportamiento en casos especiales</h3>
          <ul>
            <li>
              Si no hay métricas con score válido (por ejemplo, dataset vacío),
              el método retorna <code>0.0</code>.
            </li>
            <li>
              Si una métrica no tiene datos suficientes y su calidad resulta
              <code>null</code>, se ignora y se renormaliza con el resto de
              pesos disponibles.
            </li>
          </ul>

          <h3>5) Interpretación del resultado</h3>
          <p>En términos prácticos:</p>
          <ul>
            <li>
              <strong>80–100</strong>: dataset muy consistente y con métricas
              "sanas".
            </li>
            <li>
              <strong>50–80</strong>: dataset usable, pero con variación notable
              o distribuciones irregulares en algunas métricas.
            </li>
            <li>
              <strong>&lt; 50</strong>: dataset con alta inestabilidad o
              anomalías claras (posibles outliers fuertes o mezcla de
              poblaciones).
            </li>
          </ul>
        </section>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.close()">
          Cerrar
        </button>
      </div>
    </ng-template>

    <ng-template #qualityInfoModal let-modal>
      <div class="modal-header">
        <h5 class="modal-title">Cómo se calcula el índice de calidad</h5>
        <button
          type="button"
          class="btn-close"
          aria-label="Cerrar"
          (click)="modal.dismiss()"
        ></button>
      </div>
      <div class="modal-body mpnn-info-body quality-metrics">
        <h4 class="fw-semibold mb-3">
          Cómo se calcula el índice de calidad por métrica (0%–100%)
        </h4>
        <p class="text-muted mb-3">
          Para cada métrica se genera un puntaje de <strong>0 a 100</strong> a
          partir de tres componentes: <strong>desempeño</strong> (qué tan
          “bueno” es el valor central dentro del rango observado),
          <strong>estabilidad</strong> (qué tan consistente es la métrica) y
          <strong>forma</strong> (si la distribución luce “sana” o está dominada
          por sesgos/colas extremas).
        </p>
        <p class="text-muted mb-3">
          El índice final se construye como una combinación ponderada:
        </p>
        <div class="formula">
          <code
            >Quality = 100 · (0.60·S<sub>perf</sub> + 0.25·S<sub>stab</sub> +
            0.15·S<sub>shape</sub>)</code
          >
        </div>
        <hr class="my-3" />
        <h5 class="fw-semibold mb-2">1) Valor central usado</h5>
        <p class="text-muted mb-2">
          Para reducir la sensibilidad a valores atípicos, se utiliza un
          “centro” robusto:
        </p>
        <div class="formula">
          <code>C = 0.7·p50 + 0.3·mean</code>
        </div>
        <p class="text-muted mb-3">
          Si no hay mediana disponible, se toma <code>C = mean</code>.
        </p>
        <hr class="my-3" />
        <h5 class="fw-semibold mb-2">2) Desempeño (S<sub>perf</sub>)</h5>
        <p class="text-muted mb-2">
          El desempeño mide dónde cae el valor central <code>C</code> dentro del
          rango <code>[min, max]</code>. La fórmula depende de si la métrica es
          “más alto es mejor” o “más bajo es mejor”.
        </p>
        <h5 class="fw-semibold mb-2 mt-3">
          2.1 Métricas donde <em>más alto es mejor</em>
        </h5>
        <p class="text-muted mb-2">
          (Ejemplos: <code>plddt</code>, <code>ptm</code>, <code>i_ptm</code>)
        </p>
        <div class="formula">
          <code>S<sub>perf</sub> = (C − min) / (max − min)</code>
        </div>
        <h5 class="fw-semibold mb-2 mt-3">
          2.2 Métricas donde <em>más bajo es mejor</em>
        </h5>
        <p class="text-muted mb-2">
          (Ejemplos: <code>pae</code>, <code>i_pae</code>, <code>rmsd</code>, y
          <code>mpnn</code> si se interpreta como energía)
        </p>
        <div class="formula">
          <code>S<sub>perf</sub> = (max − C) / (max − min)</code>
        </div>
        <p class="text-muted mb-3">
          En ambos casos se aplica un recorte para mantener el valor en
          <code>[0, 1]</code>:
          <code>S<sub>perf</sub> = clip(S<sub>perf</sub>, 0, 1)</code>. Si
          <code>max == min</code>, se toma <code>S<sub>perf</sub> = 1</code>.
        </p>
        <hr class="my-3" />
        <h5 class="fw-semibold mb-2">3) Estabilidad (S<sub>stab</sub>)</h5>
        <p class="text-muted mb-2">
          La estabilidad se calcula a partir del
          <strong>coeficiente de variación</strong>:
        </p>
        <div class="formula">
          <code>CV = std / |mean|</code>
        </div>
        <p class="text-muted mb-2">
          Si <code>std</code> es nulo o <code>mean</code> es prácticamente cero,
          se fuerza <code>CV = 10</code>
          para penalizar el caso (evita divisiones inestables).
        </p>
        <p class="text-muted mb-2">
          Luego se convierte a score con una función exponencial (castiga
          variación alta de forma suave):
        </p>
        <div class="formula">
          <code>S<sub>stab</sub> = exp( −CV / τ )</code>
        </div>
        <p class="text-muted mb-3">
          Con el parámetro <code>τ = 0.25</code>. (Entre más grande sea el CV,
          más baja la estabilidad.)
        </p>
        <hr class="my-3" />
        <h5 class="fw-semibold mb-2">
          4) Forma de la distribución (S<sub>shape</sub>)
        </h5>
        <p class="text-muted mb-2">
          Aquí se usan <strong>skew</strong> y <strong>kurtosis</strong>. En
          este cálculo, la kurtosis es <strong>excess kurtosis</strong> (se
          resta 3), así que el valor “ideal” está cerca de <code>0</code>.
        </p>
        <h5 class="fw-semibold mb-2 mt-3">4.1 Penalización por sesgo (skew)</h5>
        <div class="formula">
          <code>S<sub>skew</sub> = exp( −|skew| / 1.0 )</code>
        </div>
        <h5 class="fw-semibold mb-2 mt-3">
          4.2 Penalización por colas (kurtosis)
        </h5>
        <div class="formula">
          <code>S<sub>kurt</sub> = exp( −|kurtosis| / 2.0 )</code>
        </div>
        <h5 class="fw-semibold mb-2 mt-3">4.3 Combinación final</h5>
        <div class="formula">
          <code
            >S<sub>shape</sub> = sqrt( S<sub>skew</sub> · S<sub>kurt</sub>
            )</code
          >
        </div>
        <hr class="my-3" />
        <h5 class="fw-semibold mb-2">5) Fórmula completa (resumen)</h5>
        <p class="text-muted mb-2">En una sola línea:</p>
        <div class="formula">
          <code
            >Quality = 100 · (0.60·S<sub>perf</sub> + 0.25·exp(−CV/0.25) +
            0.15·sqrt( exp(−|skew|) · exp(−|kurtosis|/2) ))</code
          >
        </div>
        <p class="text-muted mb-3">
          Donde <code>S<sub>perf</sub></code> se calcula según si la métrica es
          “alto es mejor” o “bajo es mejor”, y todo se mantiene dentro de rangos
          válidos con <code>clip()</code>.
        </p>
        <hr class="my-3" />
        <h4 class="fw-semibold mb-3">Índice global del dataset</h4>
        <p class="text-muted mb-2">
          La calidad global se obtiene agregando los scores de las métricas. La
          opción más directa es el promedio:
        </p>
        <div class="formula">
          <code>Q<sub>dataset</sub> = (1/n) · Σ Q<sub>j</sub></code>
        </div>
        <p class="text-muted mb-2">
          Si se quiere dar más importancia a ciertas métricas, se usa un
          promedio ponderado:
        </p>
        <div class="formula">
          <code
            >Q<sub>dataset</sub> = Σ (w<sub>j</sub> · Q<sub>j</sub>),
            &nbsp;&nbsp;con&nbsp; Σ w<sub>j</sub> = 1</code
          >
        </div>
        <p class="text-muted mb-0">
          En ambos casos el resultado se interpreta igual: un valor cercano a
          100 indica métricas consistentes, con buena posición relativa dentro
          de su rango y distribuciones sin anomalías fuertes.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.close()">
          Cerrar
        </button>
      </div>
    </ng-template>
  </div>
</div>
