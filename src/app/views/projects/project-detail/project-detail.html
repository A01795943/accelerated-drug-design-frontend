<div class="row">
  <div class="col-xl-12">
    @if (loading && !project) {
      <p class="text-muted">Loading project…</p>
    } @else if (error) {
      <div class="alert alert-warning">{{ error }}</div>
    } @else if (project) {
      <!-- Project details card (collapsible) -->
      <div class="card mb-4">
        <div class="card-header d-flex align-items-center justify-content-between gap-2 py-3 px-4">
          <h4 class="card-title mb-0">Project details</h4>
          <button
            type="button"
            class="btn btn-sm btn-outline-secondary d-inline-flex align-items-center justify-content-center rounded-circle"
            style="width: 2rem; height: 2rem;"
            [attr.aria-expanded]="!projectDetailsCollapsed"
            aria-controls="projectDetailsBody"
            (click)="projectDetailsCollapse.toggle()"
            [attr.title]="projectDetailsCollapsed ? 'Show' : 'Hide'"
          >
            <iconify-icon [icon]="projectDetailsCollapsed ? 'solar:alt-arrow-down-bold' : 'solar:alt-arrow-up-bold'" class="fs-5"></iconify-icon>
          </button>
        </div>
        <div #projectDetailsCollapse="ngbCollapse" [(ngbCollapse)]="projectDetailsCollapsed" id="projectDetailsBody" class="collapse show">
        <div class="card-body">
          <div class="row">
            <div class="col-lg-6 mb-3">
              <label class="form-label text-muted small mb-1">Name</label>
              <p class="mb-0 fw-medium">{{ project.name }}</p>
            </div>
            <div class="col-lg-6 mb-3">
              <label class="form-label text-muted small mb-1">Description</label>
              <p class="mb-0">{{ project.description || '—' }}</p>
            </div>
            <div class="col-lg-6 mb-3">
              <div class="d-flex align-items-center gap-2 mb-1">
                <label class="form-label text-muted small mb-0">Target</label>
                <button type="button" class="btn btn-sm btn-outline-secondary" (click)="openPdbModal(project.target, 'Target')" title="Show PDB content">
                  Show PDB
                </button>
              </div>
              <app-pdb-viewer [pdbContent]="project.target" title="Target"></app-pdb-viewer>
            </div>
            <div class="col-lg-6 mb-3">
              <div class="d-flex align-items-center gap-2 mb-1">
                <label class="form-label text-muted small mb-0">Complex</label>
                <button type="button" class="btn btn-sm btn-outline-secondary" (click)="openPdbModal(project.complex, 'Complex')" title="Show PDB content">
                  Show PDB
                </button>
              </div>
              <app-pdb-viewer [pdbContent]="project.complex" title="Complex"></app-pdb-viewer>
            </div>
          </div>
        </div>
        </div>
      </div>

      <!-- Backbones section (collapsible) -->
      <div class="card mb-4">
        <div class="card-header d-flex align-items-center justify-content-between gap-2 py-3 px-4">
          <h4 class="card-title mb-0">Backbones</h4>
          <div class="d-flex align-items-center gap-2">
            <button type="button" class="btn btn-sm btn-primary" (click)="openAddBackboneModal()">Add backbone</button>
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary d-inline-flex align-items-center justify-content-center rounded-circle"
              style="width: 2rem; height: 2rem;"
              [attr.aria-expanded]="!backbonesSectionCollapsed"
              aria-controls="backbonesBody"
              (click)="backbonesSectionCollapsed = !backbonesSectionCollapsed"
              [attr.title]="backbonesSectionCollapsed ? 'Show' : 'Hide'"
            >
              <iconify-icon [icon]="backbonesSectionCollapsed ? 'solar:alt-arrow-down-bold' : 'solar:alt-arrow-up-bold'" class="fs-5"></iconify-icon>
            </button>
          </div>
        </div>
        <div #backbonesCollapse="ngbCollapse" [(ngbCollapse)]="backbonesSectionCollapsed" id="backbonesBody" class="collapse show">
          <div class="card-body">
            @if (backbones.length === 0) {
              <p class="text-muted mb-0">No backbones yet. Click "Add backbone" to create one.</p>
            } @else {
              <div class="row g-3">
                @for (bb of backbones; track bb.id) {
                  <div class="col-md-6">
                    <div class="card h-100 border shadow-sm position-relative">
                      <div class="card-body p-3 position-relative">
                        <div class="d-flex justify-content-between align-items-start gap-2 mb-2">
                          <div>
                            <span class="text-muted small">#{{ bb.id }}</span>
                            <span class="fw-medium ms-1">{{ bb.name }}</span>
                          </div>
                          <span class="badge {{ bb.status === 'COMPLETED' ? 'bg-success-subtle text-success' : (bb.status === 'ERROR' ? 'bg-danger-subtle text-danger' : 'bg-primary-subtle text-primary') }}">{{ bb.status || '—' }}</span>
                        </div>
                        <dl class="row row-cols-1 g-1 small mb-2">
                          <div class="col">
                            <dt class="d-inline text-muted">Contigs:</dt>
                            <dd class="d-inline ms-1 mb-0 text-truncate" [title]="bb.contigs || ''">{{ (bb.contigs || '—') | slice:0:60 }}{{ (bb.contigs?.length || 0) > 60 ? '…' : '' }}</dd>
                          </div>
                          <div class="col">
                            <dt class="d-inline text-muted">Hotspots:</dt>
                            <dd class="d-inline ms-1 mb-0 text-truncate" [title]="bb.hotspots || ''">{{ (bb.hotspots || '—') | slice:0:60 }}{{ (bb.hotspots?.length || 0) > 60 ? '…' : '' }}</dd>
                          </div>
                          <div class="col">
                            <dt class="d-inline text-muted">Chains to remove:</dt>
                            <dd class="d-inline ms-1 mb-0 text-truncate" [title]="bb.chainsToRemove || ''">{{ (bb.chainsToRemove || '—') | slice:0:60 }}{{ (bb.chainsToRemove?.length || 0) > 60 ? '…' : '' }}</dd>
                          </div>
                        </dl>
                        @if (bb.status === 'COMPLETED' && bb.structure) {
                          <div class="mt-2">
                            <div class="mb-1">
                              <button type="button" class="btn btn-sm btn-outline-secondary" (click)="openPdbModal(bb.structure, bb.name)">Show PDB</button>
                            </div>
                            <app-pdb-viewer [pdbContent]="bb.structure" [title]="bb.name" [height]="220"></app-pdb-viewer>
                          </div>
                        } @else if (bb.status === 'ERROR' && bb.error) {
                          <div class="mt-2">
                            <label class="form-label small text-muted mb-1">Error details</label>
                            <textarea class="form-control form-control-sm font-monospace small" rows="3" readonly [value]="bb.error"></textarea>
                          </div>
                        } @else if (bb.status === 'RUNNING') {
                          <div class="mt-2 py-2 small text-muted">Running…</div>
                        }
                        <button
                          type="button"
                          class="btn btn-sm btn-outline-danger position-absolute bottom-0 end-0 m-2 d-inline-flex align-items-center gap-1"
                          (click)="openConfirmDeleteBackbone(bb)"
                          title="Delete backbone"
                          aria-label="Delete backbone"
                        >
                          <iconify-icon icon="solar:trash-bin-2-outline" class="fs-6"></iconify-icon>
                          Delete
                        </button>
                      </div>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Generación de datos sintéticos (collapsible) -->
      <div class="card mb-4">
        <div class="card-header d-flex align-items-center justify-content-between gap-2 py-3 px-4">
          <h4 class="card-title mb-0">Generación de datos sintéticos</h4>
          <div class="d-flex align-items-center gap-2">
            <button type="button" class="btn btn-sm btn-primary" (click)="openAddGenerationJobModal()" [disabled]="completedBackbones.length === 0">
              Nuevo job
            </button>
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary d-inline-flex align-items-center justify-content-center rounded-circle"
              style="width: 2rem; height: 2rem;"
              [attr.aria-expanded]="!generationJobsSectionCollapsed"
              aria-controls="generationJobsBody"
              (click)="generationJobsSectionCollapsed = !generationJobsSectionCollapsed"
              [attr.title]="generationJobsSectionCollapsed ? 'Show' : 'Hide'"
            >
              <iconify-icon [icon]="generationJobsSectionCollapsed ? 'solar:alt-arrow-down-bold' : 'solar:alt-arrow-up-bold'" class="fs-5"></iconify-icon>
            </button>
          </div>
        </div>
        <div #generationJobsCollapse="ngbCollapse" [(ngbCollapse)]="generationJobsSectionCollapsed" id="generationJobsBody" class="collapse show">
          <div class="card-body">
            @if (generationJobs.length === 0) {
              <p class="text-muted mb-0">No jobs yet. Click "Nuevo job" to create one (requires a completed backbone).</p>
            } @else {
              <div class="table-responsive">
                <table class="table align-middle mb-0 table-hover">
                  <thead class="bg-light-subtle">
                    <tr>
                      <th>Run ID</th>
                      <th>Backbone</th>
                      <th>Status</th>
                      <th>Temperature</th>
                      <th>Num seqs</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (job of generationJobs; track job.id) {
                      <tr>
                        <td><span class="small font-monospace">{{ job.runId ?? '—' }}</span></td>
                        <td>{{ job.backbone?.name ?? '—' }}</td>
                        <td>
                          <span class="badge {{ job.status === 'COMPLETED' ? 'bg-success-subtle text-success' : (job.status === 'ERROR' ? 'bg-danger-subtle text-danger' : 'bg-primary-subtle text-primary') }}">{{ job.status ?? '—' }}</span>
                        </td>
                        <td>{{ job.temperature ?? '—' }}</td>
                        <td>{{ job.numSeqs ?? '—' }}</td>
                        <td>
                          <div class="d-flex gap-1 flex-wrap">
                            @if (job.status === 'COMPLETED') {
                              <button type="button" class="btn btn-sm btn-outline-secondary" (click)="downloadCsv(job)" title="Download CSV">CSV</button>
                              <button type="button" class="btn btn-sm btn-outline-secondary" (click)="downloadFasta(job)" title="Download FASTA">FASTA</button>
                              <a [routerLink]="['/projects/detail', project.id, 'job', job.id]" class="btn btn-sm btn-outline-primary">Details</a>
                            }
                            @if (job.status === 'ERROR') {
                              <button type="button" class="btn btn-sm btn-outline-warning d-inline-flex align-items-center gap-1" (click)="openJobErrorModal(job)" title="View error details">
                                <iconify-icon icon="solar:danger-circle-outline" class="fs-6"></iconify-icon>
                                Error
                              </button>
                            }
                            <button type="button" class="btn btn-sm btn-outline-danger d-inline-flex align-items-center gap-1" (click)="openConfirmDeleteJob(job)" title="Delete job">
                              <iconify-icon icon="solar:trash-bin-2-outline" class="fs-6"></iconify-icon>
                              Delete
                            </button>
                          </div>
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            }
          </div>
        </div>
      </div>
    }
  </div>
</div>

<ng-template #confirmDeleteBackboneTpl>
  <div class="modal-header">
    <h5 class="modal-title">Delete backbone</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="cancelDeleteBackbone()"></button>
  </div>
  <div class="modal-body">
    @if (backboneToDelete) {
      <p class="mb-0">Are you sure you want to delete <strong>{{ backboneToDelete.name }}</strong>? This cannot be undone.</p>
    }
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline-secondary" (click)="cancelDeleteBackbone()">Cancel</button>
    <button type="button" class="btn btn-danger" (click)="confirmDeleteBackbone()">Delete</button>
  </div>
</ng-template>

<ng-template #confirmDeleteJobTpl>
  <div class="modal-header">
    <h5 class="modal-title">Delete generation job</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="cancelDeleteJob()"></button>
  </div>
  <div class="modal-body">
    @if (jobToDelete) {
      <p class="mb-0">Are you sure you want to delete job <strong>{{ jobToDelete.runId ?? jobToDelete.id }}</strong>? This cannot be undone.</p>
    }
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline-secondary" (click)="cancelDeleteJob()">Cancel</button>
    <button type="button" class="btn btn-danger" (click)="confirmDeleteJob()">Delete</button>
  </div>
</ng-template>

<ng-template #jobErrorModalTpl>
  <div class="modal-header">
    <h5 class="modal-title">Job error details</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="closeJobErrorModal()"></button>
  </div>
  <div class="modal-body">
    @if (jobErrorForModal) {
      <p class="small text-muted mb-2">Run ID: <span class="font-monospace">{{ jobErrorForModal.runId ?? jobErrorForModal.id }}</span></p>
      <label class="form-label small text-muted">Error</label>
      <textarea class="form-control font-monospace small" rows="8" readonly [value]="jobErrorForModal.error ?? ''"></textarea>
    }
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="closeJobErrorModal()">Close</button>
  </div>
</ng-template>
